<!DOCTYPE html>
<html>
<head>
    <title>Manager Dashboard</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ccc;
            justify-content: flex-start; /* Align tabs to the left */
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            color: #555;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        .tab-content.active {
            display: block;
        }
        /* Basic table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
            font-weight: bold;
        }
        /* Basic button styling */
        button, .button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            margin-right: 10px;
        }
        button:hover, .button:hover {
            background-color: #0056b3;
        }
        .filter-box {
            background-color: #f9f9f9; /* Light grey background */
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            display: flex;
            align-items: center; /* Vertically center the label and select */
            gap: 10px; /* Space between label and select */
        }

        .filter-box label {
            font-weight: bold;
            margin-right: 10px; /* Add some space between label and dropdown */
        }

        .filter-box select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        .pagination {
            margin-top: 20px;
        }

        .pagination a, .pagination span {
            display: inline-block;
            padding: 8px 12px;
            margin-right: 5px;
            border: 1px solid #ddd;
            text-decoration: none;
            color: #333;
        }

        .pagination a:hover {
            background-color: #f0f0f0;
        }

        .pagination span.current {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .logout-button {
            margin-left: auto; /* Push to the right */
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Welcome, {{ salesperson_name }}!</h1>
    <div class="container">

        <div class="tabs">
            <button class="tab active" onclick="openTab('leads')">Leads</button>
            <button class="tab" onclick="openTab('sales-team')">Sales Team</button>
            <a href="/logout" class="button logout-button">Logout</a>  </div>

        <div id="leads" class="tab-content active">

            <div class="filter-box" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div>
                        <label for="salesperson_filter">Sales Person:</label>
                        <select id="salesperson_filter" name="salesperson_filter" onchange="applyFilters()">
                            <option value="" {% if not request.args.get('salesperson_id') %}selected{% endif %}>All Salespeople</option>
                            {% for salesperson in salespeople %}
                            <option value="{{ salesperson.salesperson_id }}" {% if request.args.get('salesperson_id') == salesperson.salesperson_id|string %}selected{% endif %}>{{ salesperson.first_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="stage_filter">Sales Stage:</label>
                        <select id="stage_filter" name="stage_filter" onchange="applyFilters()">
                            <option value="" {% if not request.args.get('stage') %}selected{% endif %}>All Stages</option>
                            {% for stage in sales_stages %}
                            <option value="{{ stage }}" {% if request.args.get('stage') == stage %}selected{% endif %}>{{ stage }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="flex-grow: 1; max-width: 300px;">
                    <label for="search_box">Search:</label>
                    <input type="text" id="search_box" name="search" placeholder="Search by company, phone, salesperson, or stage" 
                           value="{{ request.args.get('search', '') }}" 
                           onkeyup="applyFilters()" 
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <!-- Customers Table -->
            <div class="table-section" style="margin-bottom: 30px;">
                <table>
                    <thead>
                        <tr>
                            <th><a href="{{ url_for('manager_dashboard', sort_by='assigned_salesperson', sort_order='asc' if sort_by != 'assigned_salesperson' or sort_order == 'desc' else 'desc', salesperson_id=request.args.get('salesperson_id', ''), page=request.args.get('page', 1)) }}">Sales person</a></th>
                            <th>Company Name</th>
                            <th>Industry</th>
                            <th>Contact Person</th>
                            <th>Position</th>
                            <th>Phone</th>
                            <th><a href="{{ url_for('manager_dashboard', sort_by='date_added', sort_order='asc' if sort_by != 'date_added' or sort_order == 'desc' else 'desc', salesperson_id=request.args.get('salesperson_id', ''), page=request.args.get('page', 1)) }}">Date Created</a></th>
                            <th><a href="{{ url_for('manager_dashboard', sort_by='last_contact', sort_order='asc' if sort_by != 'last_contact' or sort_order == 'desc' else 'desc', salesperson_id=request.args.get('salesperson_id', ''), page=request.args.get('page', 1)) }}">Last Contact</a></th>
                            <th><a href="{{ url_for('manager_dashboard', sort_by='sales_stage', sort_order='asc' if sort_by != 'sales_stage' or sort_order == 'desc' else 'desc', salesperson_id=request.args.get('salesperson_id', ''), page=request.args.get('page', 1)) }}">Sales Stage</a></th>
                            <th><a href="{{ url_for('manager_dashboard', sort_by='next_followup_date', sort_order='asc' if sort_by != 'next_followup_date' or sort_order == 'desc' else 'desc', salesperson_id=request.args.get('salesperson_id', ''), page=request.args.get('page', 1)) }}">Next Follow-up</a></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>{{ customer.assigned_salesperson or 'N/A' }}</td>
                            <td><a href="{{ url_for('customer_detail', customer_id=customer.customer_id) }}">{{ customer.company_name }}</a></td>
                            <td>{{ customer.company_industry or 'N/A' }}</td>
                            <td>{{ customer.contact_person or 'N/A' }}</td>
                            <td>{{ customer.contact_person_position or 'N/A' }}</td>
                            <td>{{ customer.phone_number or 'N/A' }}</td>
                            <td>{{ customer.date_added }}</td>
                            <td>{{ customer.last_contact_date or 'N/A' }}</td>
                            <td>{{ customer.current_sales_stage or 'N/A' }}</td>
                            <td>{{ customer.next_followup_date or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <a href="{{ url_for('add_customer') }}" class="button">Create New Customer</a>
                    <div class="pagination">
                        {% if page > 1 %}
                            <a href="{{ url_for('manager_dashboard', page=page - 1, salesperson_id=request.args.get('salesperson_id', ''), sort_by=request.args.get('sort_by', 'date_added'), sort_order=request.args.get('sort_order', 'desc')) }}">&laquo; Previous</a>
                        {% endif %}

                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                                <span class="current">{{ p }}</span>
                            {% else %}
                                <a href="{{ url_for('manager_dashboard', page=p, salesperson_id=request.args.get('salesperson_id', ''), sort_by=request.args.get('sort_by', 'date_added'), sort_order=request.args.get('sort_order', 'desc')) }}">{{ p }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page < total_pages %}
                            <a href="{{ url_for('manager_dashboard', page=page + 1, salesperson_id=request.args.get('salesperson_id', ''), sort_by=request.args.get('sort_by', 'date_added'), sort_order=request.args.get('sort_order', 'desc')) }}">Next &raquo;</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sales Stage Chart Section -->
            <div class="chart-section" style="margin-bottom: 30px; direction: ltr;">
                <h2 style="text-align: left; margin-bottom: 20px;">Sales Stage</h2>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <canvas id="salesStageChart"></canvas>
                    </div>
                    <div style="flex: 1;">
                        <table class="stage-details" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Stage</th>
                                    <th style="text-align: center;">Count</th>
                                    <th style="text-align: center;">Total Value</th>
                                    <th style="text-align: center;">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stage, data in sales_stage_counts.items() %}
                                <tr>
                                    <td style="text-align: left;">{{ stage }}</td>
                                    <td style="text-align: center;">{{ data.count }}</td>
                                    <td style="text-align: center;">ر.س {{ "{:,.0f}".format(data.total_value|float) }}</td>
                                    <td style="text-align: center;">{{ data.percentage }}</td>
                                </tr>
                                {% endfor %}
                                <tr style="font-weight: bold; border-top: 2px solid #ddd;">
                                    <td style="text-align: left;">Total</td>
                                    <td style="text-align: center;">{{ total_customers_filtered }}</td>
                                    <td style="text-align: center;">ر.س {{ "{:,.0f}".format(sales_stage_counts.values()|sum(attribute='total_value')|float) }}</td>
                                    <td style="text-align: center;">100%</td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="margin-top: 10px; font-weight: bold;">
                            Total Customers: {{ total_customers_filtered }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Stage Details Section -->
            <div class="stage-details" style="margin-bottom: 30px; direction: ltr;">
                <h2 style="text-align: left; margin-bottom: 20px;">Sales Pipeline</h2>
                {% for stage, data in pipeline_by_stage.items() %}
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; cursor: pointer;" onclick="toggleStage('{{ stage|replace(' ', '_') }}')">
                        <h3 style="margin: 0; flex-grow: 1;">{{ stage }}</h3>
                        <span style="margin-right: 10px; font-weight: bold;">Total Value: ر.س {{ "{:,.0f}".format(data.total_value|float) }}</span>
                        <span class="toggle-icon" id="toggle-icon-{{ stage|replace(' ', '_') }}">▼</span>
                    </div>
                    <div id="{{ stage|replace(' ', '_') }}" style="display: block;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            {% for company in data.companies %}
                            <div style="background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: bold;">
                                        <a href="{{ url_for('customer_detail', customer_id=company.customer_id) }}">{{ company.company }}</a>
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">
                                        No.follow-up: {{ company.followup_count }}
                                    </div>
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Contact Person:</span> {{ company.contact_person or 'N/A' }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Phone:</span> {{ company.phone_number or 'N/A' }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Salesperson:</span> {{ company.salesperson }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Next Action:</span> {{ company.next_action or 'N/A' }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Due Date:</span> {{ company.next_action_date or 'N/A' }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Value:</span> {{ company.deal_value or 'N/A' }}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <span style="color: #666;">Last Contact:</span> {{ company.summary or 'N/A' }}
                                </div>
                                <div style="margin-top: 10px;">
                                    <a href="{{ url_for('assign_customer', customer_id=company.customer_id) }}" class="button small" style="padding: 5px 10px; font-size: 0.9em;">Change Salesperson</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <script>
                function toggleStage(stageId) {
                    const content = document.getElementById(stageId);
                    const icon = document.getElementById('toggle-icon-' + stageId);
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        icon.textContent = '▶';
                    }
                }

                // Sales Stage Chart
                const ctx = document.getElementById('salesStageChart').getContext('2d');
                const salesStages = {{ sales_stage_counts.keys()|list|tojson }};
                const stageCounts = {{ sales_stage_counts.values()|list|tojson }};
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: salesStages,
                        datasets: [{
                            label: 'عدد العملاء',
                            data: stageCounts.map(item => item.count),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'عدد العملاء'
                                }
                            }
                        }
                    }
                });
            </script>

            <div id="sales-team" class="tab-content">
                <h2>Sales Team Management</h2>
            </div>
        </div>

        <script>
            function applyFilters() {
                const salespersonId = document.getElementById('salesperson_filter').value;
                const stage = document.getElementById('stage_filter').value;
                const search = document.getElementById('search_box').value;
                
                let url = '/manager/dashboard?';
                const params = [];
                
                if (salespersonId) params.push(`salesperson_id=${salespersonId}`);
                if (stage) params.push(`stage=${encodeURIComponent(stage)}`);
                if (search) params.push(`search=${encodeURIComponent(search)}`);
                
                url += params.join('&');
                window.location.href = url;
            }

            function openTab(tabName) {
                var i, tabContent, tabButtons;
                tabContent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabContent.length; i++) {
                    tabContent[i].classList.remove("active");
                }
                tabButtons = document.getElementsByClassName("tab");
                for (i = 0; i < tabButtons.length; i++) {
                    tabButtons[i].classList.remove("active");
                }
                document.getElementById(tabName).classList.add("active");
                event.currentTarget.classList.add("active");
            }
        </script>
    </div>
</body>
</html>